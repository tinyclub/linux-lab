---
title: è®¤è¯†ç¥ç»ç½‘ç»œï¼šæ¨ç†æ˜¯æ€æ ·ä¸€ç§è´Ÿè½½
author: Chen Jie
layout: post
draft: true
top: false
album:
permalink: /infer-intro
tags:
  - Inference
  - Multimedia
  - Acceleration
  - Neural Network
category:
  - ML
---

<!-- è®¤è¯†ç¥ç»ç½‘ç»œï¼šæ¨ç†æ˜¯æ€æ ·ä¸€ç§è´Ÿè½½ -->

<!-- %s/!\[image\](/&\/wp-content\/uploads\/2020\/06\/infer-intro\// -->

> by Chen Jie of [TinyLab.org](http://tinylab.org/)
> 2020/06/09

## å‰è¨€

åœ¨ PC å’Œç§»åŠ¨ç«¯è®¾å¤‡ä¸­ï¼Œå¤šåª’ä½“ç®—å¾—ä¸Šæ˜¯ä¼ ç»Ÿçš„è®¡ç®—å¯†é›†å‹è´Ÿè½½ã€‚ä¼´éš Resolution ä» 720P åˆ° 4Kï¼Œä¼´éš Codec ä» MPEG4 åˆ° H264 å†åˆ° H265ï¼Œä¼´éšç¼–ç åœºåˆçš„å¢åŠ ï¼Œæ¯ä¸€æ¬¡å¯¹ç¡¬ä»¶ç®—åŠ›æå‡ºæ›´å¤šè¦æ±‚ã€‚

ç›´åˆ°..ç¥ç»ç½‘ç»œå…´èµ·ï¼Œå…¶æ¨ç†è´Ÿè½½ä¸€è·ƒæˆä¸ºç®—åŠ›é¡¶çº§å·¨å…½ã€‚é‚£ä¹ˆï¼Œä¸ä¼ ç»Ÿå¤šåª’ä½“åº”ç”¨ç›¸æ¯”ï¼Œæ¨ç†è´Ÿè½½æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

é¦–å…ˆé“ºå«ä¸€äº›ç¥ç»ç½‘ç»œçš„èƒŒæ™¯ï¼Œç†Ÿæ‚‰çš„ç«¥é‹å¯ä»¥è·³è¿‡ã€‚

## èƒŒæ™¯ï¼šè®¤è¯†ç¥ç»ç½‘ç»œ

ä¸‹é¢ä»ä¸€ä¸ªç‰©ä½“è¯†åˆ«ç½‘ç»œï¼ˆSSDï¼‰æ¥å¿«é€Ÿå»ºç«‹ç¬¬ä¸€å°è±¡ã€‚

> æœ¬ä¾‹å­å–è‡ª [SSD object detection: Single Shot MultiBox Detector for real-time processing](https://medium.com/@jonathan_hui/ssd-object-detection-single-shot-multibox-detector-for-real-time-processing-9bd8deac0e06)ï¼ŒJonathan Hui
>
> å¦éœ€æŒ‡å‡ºï¼Œç›¸å…³æŠ€æœ¯æ—¥æ–°æœˆå¼‚ï¼Œæœ¬ä¾‹æåŠæŠ€æœ¯å·²é state of artï¼Œä½†ä»å€¼å¾—ä»¥å®ƒå…¥æ‰‹ï¼Œæ¥äº†è§£ä¸‹ç¥ç»ç½‘ç»œã€‚

ç‰©ä½“è¯†åˆ«ç½‘ç»œå…¶æ•ˆæœå¦‚ä¸‹å›¾ï¼š

![image](/wp-content/uploads/2020/06/infer-intro/SSD-result.jpg)

è¿™ä¸ªç»“æœç¤ºæ„å›¾ä¸­ï¼Œç½‘ç»œè¯†åˆ«å‡ºäº†ä¸¤ç±»ã€äº”ä¸ªç‰©ä½“ï¼š

- æœ€å·¦ 1 ä¸ª Binding Boxï¼Œæ ‡ç­¾ä¸ºâ€œ15â€ï¼ˆpersonï¼‰çš„ä¹°èœå¤§å”ã€‚ç½®ä¿¡åº¦ä¸º 0.953
- å…¶ä½™ 4 ä¸ª Binding Boxesï¼Œ æ ‡ç­¾ä¸ºâ€œ7â€ï¼ˆcarï¼‰çš„å››è¾†å°æ±½è½¦ã€‚ç•™æ„æœ€å³ Binding box çš„æ±½è½¦ï¼Œç”±äºè£å‡å’Œé®æŒ¡çš„ç¼˜æ•…ï¼Œç½®ä¿¡åº¦åªæœ‰ 0.562ã€‚

äº§ç”Ÿä¸Šè¿°ç»“æœçš„ç¥ç»ç½‘ç»œ â€”â€” SSD å¦‚ä¸‹å›¾æ‰€å±•ç¤ºï¼š ![image](/wp-content/uploads/2020/06/infer-intro/SSD-network.jpg)

- Inputï¼šè¾“å…¥å›¾ç‰‡ï¼Œ300x300ï¼Œ3 é€šé“ (R/G/B)
- Backboneï¼šå›¾ç¤ºéª¨å¹²ç½‘æ˜¯ VGG-16

> ç•™æ„åˆ°éª¨å¹²ç½‘çš„è¾“å…¥ä¸º 300x300x3ï¼Œè¾“å‡ºä¸º 19x19x1024
>
> - å°ºå¯¸ç¼©å°ï¼š300x300 â†’ 19x19
> - é€šé“å˜å¤šï¼š3 â†’ 1024
>
> è®ºæ–‡æ›°ï¼šå°†ç”»é¢ä¸­çš„ä¿¡æ¯ç¼–ç åœ¨é«˜ç»´ç©ºé—´ã€‚æ•…è€Œ Backbone ä¹Ÿç§°ä½œç¼–ç å™¨ã€‚
>
> ä¸ä¹‹ç›¸å¯¹çš„ï¼Œåœ¨åƒç´ åˆ†å‰²ä»»åŠ¡ä¸­ï¼Œä¼šæŠŠé«˜ç»´ç©ºé—´ä¸­çš„ä¿¡æ¯ï¼Œé€ä¸€è§£å¼€åˆ°å¹³é¢ï¼Œæ•…è€Œä¹Ÿå«åšè§£ç å™¨ã€‚

è€ƒè™‘å¦‚ä½•ä» _ç¼–ç åœ¨é«˜ç»´ç©ºé—´ä¸­çš„ä¿¡æ¯_ ä¸­æå–æœ€ç»ˆç»“æœã€‚

é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯æœ€ç»ˆç»“æœï¼Ÿå®ƒåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- Binding box â€”â€” x,y, width, height
- Binding box åœ¨å„ç±»åˆ«çš„ç½®ä¿¡åº¦ã€‚ä¾‹å¦‚åˆ† 20 ç±»ï¼ˆ20 Classesï¼‰ï¼ŒåŠ ä¸ŠèƒŒæ™¯ç±»ï¼ˆNo Object)ï¼Œæ€»å…± 21 ç±» â€”â€” å°±æœ‰ 21 ä¸ªç½®ä¿¡åº¦

å…¶æ¬¡ï¼Œè¯¥ç½‘ç»œä¼šåœ¨ 6 ä¸ªä¸åŒçš„åˆ†è¾¨ç‡ä¸Šï¼ˆå›¾ä¸­ï¼Œç”¨äºæå–çš„ Feature map å°ºå¯¸åˆ†åˆ«ä¸º 38x38ã€19x19ã€10x10ã€5x5ã€3x3ã€1x1ï¼‰ï¼Œè¾“å‡ºç‰©ä½“è¯†åˆ«ç»“æœï¼Œå…¶ä¸­ï¼š

- Feature map å°ºå¯¸è¶Šå¤§ï¼Œå…¶åƒç´ å¯¹åº”åŸå›¾åŒºåŸŸè¶Šå°ï¼Œä»è€Œæ³¨é‡åŸå›¾ç»†èŠ‚ â€”â€” å¯¹å°å°ºå¯¸ç‰©ä½“æ•æ„Ÿã€‚
- Feature map å°ºå¯¸è¶Šå°ï¼Œå…¶åƒç´ å¯¹åº”åŸå›¾åŒºåŸŸï¼ˆæœ¯è¯­æ›°ï¼šReceptive fieldï¼Œæ„Ÿå—é‡ï¼‰è¶Šå¤§ï¼Œä»è€Œæ³¨é‡å¤§å±€ â€”â€” å¯¹å æ®åŸå›¾åŠå£æ±Ÿå±±çš„å¤§å°ºå¯¸ç‰©ä½“ï¼Œè¯†åˆ«æ•ˆæœå¥½ã€‚

æœ€åï¼Œä¸Šå›¾ä¸­æ©™è‰²æ ‡å‡ºäº†æŸä¸ªåˆ†è¾¨ç‡ _è¾“å‡ºæœ€ç»ˆç»“æœ_ çš„è¿‡ç¨‹

- Feature map å°ºå¯¸ä¸º 3x3ï¼Œå®ƒè¾“å‡ºäº† 3x3x4 ä¸ªç»“æœ
  - æ¯ä¸ªç»“æœæœ‰ 64ï¼Œå³ Binding box æœ¬èº«ï¼Œä»¥åŠ 60 ä¸ªåˆ†ç±»ï¼ˆå«èƒŒæ™¯ï¼‰
- å…¶ä¸­ï¼Œ3x3x4 ä»£è¡¨äº† Anchor boxes çš„æ•°é‡ã€‚
  - "4" ä»£è¡¨å¯¹æ¯ä¸ªåƒç´ ï¼Œåˆ†åˆ«ç”Ÿæˆäº† 4 ä¸ª Anchor boxes
  - ä»€ä¹ˆæ˜¯ Anchor boxes å‘¢ï¼Ÿä¸‹å›¾ä¸ºä¸€ä¸ª 8x8 Feature Mapï¼ŒæŸä¸ªåƒç´ ä¸Šçš„ 4 ä¸ª Anchor boxes

![image](/wp-content/uploads/2020/06/infer-intro/SSD-anchor-boxes.jpeg)

- åŸºäºæŸä¸ª Anchor boxï¼Œç½‘ç»œæ¨ç†å‡ºä¸€ä¸ª Binding box (ğœŸcxï¼ŒğœŸcy, w, h)
- æ­¤æ—¶ï¼Œä¹°èœå¤§å”çš„æ¯ä¸ªåƒç´ å°±æœ‰ 4 ä¸ªå€™é€‰ Binding boxes
  - â€”â€” éœ€è¦ pk å‡ºæœ€ä½³ Binding box
  - pk é€šè¿‡åä¸º â€œNMS çš„åå¤„ç†â€ æ¥è¿›è¡Œã€‚NMS æ„ä¸ºéæå¤§å€¼æŠ‘åˆ¶ï¼ˆNon Maximum Suppressionï¼‰

### Convolutionï¼šç¥ç»ç½‘ç»œçš„åŸºç¡€ç®—å­

åœ¨ä¸Šè¿° SSD ç½‘ç»œä¸­ï¼Œæ¯ä¸€å±‚å‡ ä¹éƒ½æ˜¯ Conv ç®—å­ã€‚

Conv æ˜¯ä¸€ä¸ªæå–ç©ºåŸŸä¿¡æ¯çš„ç®—å­ï¼Œç”±å®ƒæ„æˆçš„ç¥ç»ç½‘ç»œå«åš CNNï¼ˆConvolutional Neural Networkï¼‰ã€‚

> ä¸ä¹‹ç›¸å¯¹çš„ï¼ŒRNN ç½‘ç»œæ˜¯ä¸€ä¸ªæå–æ—¶åŸŸä¿¡æ¯çš„ç½‘ç»œï¼Œå¸¸ç”¨äºå¦‚è¯­éŸ³è¯†åˆ«ã€‚å®ƒä¹Ÿç”±åŸºæœ¬ç®—å­æ‰€ç»„æˆã€‚

ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ª 3x3 çš„ Conv ç®—å­ï¼Œå…¶æ°´å¹³å’Œå‚ç›´æ–¹å‘çš„ stride ä¸º 2ï¼Œpadding ä¸º 1ï¼š

![image](/wp-content/uploads/2020/06/infer-intro/conv3x3-s2.gif)

- è¾“å…¥å›¾ç‰‡ç» padding åï¼Œå°ºå¯¸ä¸º 5x5
- å¯¹å…¶é‚»è¿‘çš„ _3x3 ä¸ªåƒç´ _ ï¼Œä¸å¯¹åº”çš„ _3x3 ä¸ªæƒé‡_ ç›¸ä¹˜ï¼Œè¾“å‡ºä¸€ä¸ªåƒç´ 

å¯¹è¾“å…¥å•ä¸ªé€šé“ï¼ˆä¾‹å¦‚ï¼ŒRã€G æˆ– B å…¶ä¸€ï¼‰ï¼Œ Convolution ä¼ªä»£ç ç¤ºæ„å¦‚ä¸‹ï¼š

```
/**
 * Input: W = 5, H = 5      |  Conv: KW = 3, KH = 3
 * Output:                  |  Stride = 2
 */
for (int i = 0; i <= H - KH; i += S)
  for (int j = 0; j <= W - KW; i += S) { // å¯¹æ¯ä¸ª 3x3 é‚»è¿‘åŒºåŸŸ

    for (int k = 0; k < KH; k++)
      for (int l = 0; l < KW; l++)
      //Output             += Input        * Weight
        O[i / 2][j / 2] += I[i + k][j + l] * W[k][l];
}
```

> å½“è€ƒè™‘è¾“å…¥æœ‰ R / G / B ä¸‰ä¸ªé€šé“æ—¶ï¼Œå„è¾“å‡ºç»“æœï¼Œéœ€è¿›ä¸€æ­¥ç´¯åŠ æˆä¸€å¼ å›¾ï¼Œå¦‚ä¸‹å›¾ï¼š
>
> ![image](/wp-content/uploads/2020/06/infer-intro/input-conv-output.jpg)
>
> å½“è€ƒè™‘ Convolution æ·±åº¦ä¸º N æ—¶ï¼Œè¾“å‡ºç»“æœä¹Ÿæœ‰ N ä¸ªé€šé“ï¼Œå¦‚ä¸‹å›¾ï¼š
>
> ![image](/wp-content/uploads/2020/06/infer-intro/input-conv-N-output.jpg)
>
> æ­¤æ—¶ï¼ŒConvolution çš„æƒé‡æ–‡ä»¶æ˜¯ä¸€ä¸ª 3x3xN çš„çŸ©é˜µã€‚
>
> è€Œæ‰€è°“è®­ç»ƒç¥ç»ç½‘ç»œè®­ç»ƒï¼Œæˆ–æ·±åº¦å­¦ä¹ ï¼Œå°±æ˜¯åœ¨ä¸€æ¬¡æ¬¡è¿­ä»£ä¸­ï¼Œæ›´æ–°æƒé‡çš„è¿‡ç¨‹ã€‚
>
> è®­ç»ƒåçš„ç½‘ç»œï¼Œå…¶æƒé‡é€šå¸¸æ˜¯å›ºå®šçš„ã€‚
> ç”¨æƒé‡å›ºå®šçš„ç½‘ç»œè®¡ç®—å¾—ç»“æœï¼Œå«åšæ¨ç†ã€‚ä¾‹å¦‚ç”¨ä¸Šè¿°è®­ç»ƒå¥½çš„ SSDï¼Œæ£€æµ‹å·¥åœ°æ–½å·¥äººå‘˜ï¼Œæ˜¯å¦ä½©æˆ´å®‰å…¨å¸½ã€‚

åœ¨é™„å½•ä¸­ï¼Œè¿›ä¸€æ­¥å±•ç¤ºäº†ä¸åŒå‚æ•°å’Œä¸åŒç±»å‹çš„ Convolutionsã€‚

### Graphï¼šç®—å­æ„æˆçš„ç½‘ç»œ

ä¸‹å›¾æ‰‹ç»˜ä¸€ç»„ç®—å­æ„æˆçš„ç¥ç»ç½‘ç»œï¼Œæˆ–å«åš Graph

![image](/wp-content/uploads/2020/06/infer-intro/The-NN-Graph.jpg)

å›¾ä¸­çš„èŠ‚ç‚¹ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

- ç®—å­æœ¬èº«ï¼ŒåŒ…æ‹¬ç±»å‹å’Œå±æ€§ã€‚ä¾‹å¦‚æŸä¸ª Convolution ç®—å­ï¼Œå±æ€§ä¸º dim=3x3x256ã€stride=1ã€padding = ...
- ç®—å­è¾“å‡ºçš„ Buffer(s)ã€‚å¯èƒ½è¾“å‡ºå¤šä¸ª Buffersï¼Œä¾‹å¦‚å›¾ä¸­çš„ Split ç®—å­
- ç®—å­çš„æƒé‡ã€‚å¹¶éæ¯ä¸ªç®—å­éƒ½æœ‰
  - æœ‰æƒé‡çš„ç®—å­å¯è¢«è®­ç»ƒ

è€Œåœ¨è°ƒç”¨ç½‘ç»œæ—¶ï¼Œéœ€å–‚ç»™å®ƒ Buffer(s) ä½œä¸ºè¾“å…¥ï¼Œå³å›¾ä¸­çš„ Inputã€‚åœ¨ Tensorflow ç§°ä¹‹ä¸º Placeholderã€‚

> æ­¤å¤„ï¼Œæ’æ’­ä¸€ä¸‹ Buffer æ ¼å¼ç®€ä»‹ã€‚
> ä¸€èˆ¬è€Œè¨€æ˜¯ 4 ç»´çš„ NCHW æˆ–è€… NHWC æ ¼å¼
> - N ä»£è¡¨ batchï¼Œä¾‹å¦‚æŸä¸ªè‡ªåŠ¨é©¾é©¶æ–¹æ¡ˆé…å¤‡äº†å·¦å³æ‘„åƒå¤´ï¼Œé‚£ä¹ˆå·¦å³ä¸¤å¸§å¯ä»¥è€ƒè™‘ batch åœ¨ä¸€èµ·é€å…¥æ¨ç†æ¥æé«˜è¿è¡Œæ•ˆç‡ã€‚
> - C ä»£è¡¨ Channel æ•°ï¼Œå¯¹äºè¾“å…¥çš„ RGB å›¾ç‰‡è€Œè¨€ï¼š
>   - CHWï¼šä»£è¡¨å…ˆæ˜¯ R planeï¼Œå†æ˜¯ G planeï¼Œæœ€åæ˜¯ B plane
>   - HWCï¼šä»£è¡¨æ€»å…±ä¸€ä¸ª planeï¼Œæ¯ä¸ªåƒç´ æ˜¯ R+G+B å…±24bits
>
> ä¸åŒçš„ Buffer æ ¼å¼ï¼Œæ˜¯ä¸ºäº†ç¡¬ä»¶æ•ˆç‡çš„è€ƒè™‘ã€‚ä¾‹å¦‚ï¼Œä¸ºè¿½æ±‚æ•ˆç‡ï¼Œè¿˜å­˜åœ¨ NCHWC æ ¼å¼ â€”â€” éƒ¨åˆ†é€šé“ç‹¬ç«‹æˆ planeï¼Œéƒ¨åˆ†é€šé“å‡‘æˆ plane ä¸­çš„ä¸€ä¸ªåƒç´ ã€‚

å†…å­˜ä¸­çš„å›¾ï¼Œå­˜ç›˜åä¾¿æœ‰äº†å„ç§å„æ ·çš„æ ¼å¼ã€‚æŒ‰ä½¿ç”¨åœºæ™¯ï¼š

- è®­ç»ƒä¸­çš„å›¾ï¼Œæƒé‡ï¼ˆWegihtsï¼‰å’Œç½‘ç»œç»“æ„åˆ†å¼€å­˜æ”¾ã€‚ä¾‹å¦‚ Tensorflow çš„ Checkpointsï¼ˆæƒé‡ï¼‰å’Œ .py ä¸­å®šä¹‰çš„ç½‘ç»œç»“æ„ã€‚
- éƒ¨ç½²åï¼Œä»…è¿›è¡Œæ¨ç†çš„å›¾ï¼š
  - æƒé‡è¢«å›ºåŒ–ï¼ˆ[freeze](https://medium.com/@prasadpal107/saving-freezing-optimizing-for-inference-restoring-of-tensorflow-models-b4146deb21b5)ï¼‰åˆ°ç½‘ç»œç»“æ„ä¸­
  - ç„¶ååºåˆ—åŒ–æˆç‰¹å®šæ ¼å¼çš„æ–‡ä»¶ã€‚è¿™æ ·çš„æ ¼å¼æœ‰è®¸å¤šï¼Œå¦‚ Tensorflow çš„ .pbï¼Œ.tfliteï¼Œä»¥åŠå…¶ä»–å¹³å°ç”Ÿæˆçš„ .onnx æ–‡ä»¶

### SubGraphï¼šå¼‚æ„è®¡ç®—çš„ç²’åº¦

ä½œä¸ºé«˜è´Ÿè½½çš„æ¨ç†ä»»åŠ¡ï¼Œä¸ºäº†èƒ½åœ¨ç«¯ä¾§å®æ—¶è¿è¡Œï¼Œç¡¬ä»¶ä¸Šä¼šé…ç½®å¤šç»„è®¡ç®—å•å…ƒã€‚ä¾‹å¦‚ Nvidia çš„ Xavier å¹³å°ï¼Œä¸ä»…æœ‰ GPU ç”¨äºæ¨ç†ï¼Œè¿˜æœ‰ä¸“ç”¨ DLA æ¥å®šå‘ offloadã€‚

è¿›è¡Œå¼‚æ„æ¨ç†è®¡ç®—æ—¶ï¼Œéœ€å°†ä¸€æ•´ä¸ªç½‘ç»œåˆ†æˆå¤šä¸ªå­ç½‘ï¼ˆSubGraphï¼‰ï¼Œä¸åŒå­ç½‘è¢«å‘å¾€ä¸åŒè®¡ç®—å•å…ƒã€‚

è¿™äº›å­ç½‘ä¼šè¿›è¡Œé’ˆå¯¹æ€§çš„è½¬æ¢ï¼Œä»¥ä¾¿åˆ©ç”¨ç›®æ ‡è®¡ç®—å•å…ƒå†…å»ºæ“ä½œã€ç‰‡ä¸Šç¼“å­˜ä»¥åŠå–æŒ‡è¿‡ç¨‹ã€‚ 



## æ­£ç‰‡ï¼šå¤šåª’ä½“ vs æ¨ç†

### ç®€ä»‹ï¼šå¤šåª’ä½“è´Ÿè½½

ä»ä¸¤ä¸ªåœºæ™¯å…¥æ‰‹æ¥å±•å¼€ç®€ä»‹ã€‚

é¦–å…ˆæ˜¯ä¸€ä¸ªç›´æ’­åœºæ™¯ï¼Œç›´æ’­æµä»¥ udp åŒ…ï¼Œå‘ç»™å®¢æˆ·ç«¯çš„ 1000 ç«¯å£ï¼Œéšåæ‹†åŒ…è§£ç ï¼Œåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå†…å®¹ï¼š

```
# ä»¥ GStreamer ä¸ºä¾‹çš„å¤šåª’ä½“ç®¡çº¿ï¼Œå…¶ä¸­ "!" ä»£è¡¨å…¶å‰åå…ƒä»¶è¿æ¥èµ·æ¥
gst-launch-1.0 udpsrc port=1000 ! application/x-rtp,payload=96,media="video",encoding-name="H264",clock-rate="90000" ! \
    rtph264depay ! h264parse ! ffdec_h264 ! waylandsink
        #  ^^^^^^^^^^^^^^^^^^^^^^^^^
```

åˆ’é‡ç‚¹éƒ¨åˆ†ï¼Œä» rtp åŒ…ä¸­è§£å‡º h264 æœ‰æ•ˆè´Ÿè½½ï¼ˆrtph264depayï¼‰ï¼Œ è¿›è¡Œ h264 æ ¼å¼è½¬æ¢ï¼ˆh264parse ä¾éœ€è¦æ˜¯å¦è½¬ä¸º bytestreamï¼‰ï¼Œæœ€åé€å…¥è§£ç å™¨ï¼ˆffdec_h264ï¼‰ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ§åˆ¶æµæ˜¯æ‰€è°“çš„ push mode â€”â€” rtph264depayã€h264parse å’Œ ffdec_h264 å°±åƒé“¾è¡¨ä¸­çš„ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸€ä¸ªæ¥ç€ä¸€ä¸ªè°ƒç”¨ï¼š

```
// ç¤ºæ„ä¼ªä»£ç 
rtph264depay->next = h264parse;
h264parse->next = ffdec_h264;

for (elem = rtph264depay; elem; elem = elem->next) {
	res = elem->func(in_bufs, out_bufs);
	in_bufs = out_bufs;
}
```

æ¥ç€æ˜¯è§†é¢‘æ’­æ”¾åœºæ™¯ã€‚ä» cloudlab.mp4 æ–‡ä»¶ä¸­ï¼Œåˆ†ç¦»å‡ºè§†é¢‘æµï¼Œéšåå¡å…¥ queueã€è§£ç å™¨å¹¶æ˜¾ç¤ºåœ¨å±å¹•ã€‚

```
gst-launch-1.0 filesrc location=cloudlab.mp4 ! qtdemux name=mdemux mdemux.video_0 ! \
    queue ! ffdec_h264 ! waylandsink
 #  ^^^^^^^^^^^^^^^^^^^^^^^^
```

ä½œä¸ºéå®æ—¶çš„åœºæ™¯ï¼Œæ’­æ”¾é€Ÿç‡ä¼šæŒ‰è®¾å®šå¸§æ•°ï¼ˆä¾‹å¦‚ 25fpsï¼‰è¿›è¡Œã€‚è¿™æ˜¯ç”± waylandsink æ¥æŠŠå…³çš„ï¼Œå®ƒä¼šæ ¹æ® Buffer çš„ timestamp æ¥å†³å®šä½•æ—¶æ¶ˆè´¹ï¼š

```
// ç¤ºæ„ä¼ªä»£ç 
consumer_thread() {
	for (;;) {
		buf = input.retrieve()
		wihle (buf.timestamp < now)
			wait();
		
		render(buf);
	}
}
```

ä¸Šè¿°æ§åˆ¶æµæ˜¯æ‰€è°“çš„ pull modeï¼Œå³é€šè¿‡ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸»åŠ¨å†³å®šä½•æ—¶è¯»å–è¾“å…¥ï¼Œå¹¶æ¸²æŸ“åœ¨å±å¹•ã€‚


é€šå¸¸è€Œè¨€ï¼Œç«¯ä¸Šä¼šæœ‰ç¡¬ä»¶çš„è§£ç å™¨ï¼Œç”¨å®ƒæ›¿æ¢ _ä¼ªä»£ç ç¤ºä¾‹ä¸­ `ffdec_h264`_ å³å¯ã€‚ä¸ºä½¿ç”¨è¿™ä¸ªè§£ç å™¨ï¼ŒBuffer éœ€ä»ç³»ç»Ÿå†…å­˜ upload åˆ°è®¾å¤‡å†…å­˜ï¼Œå¹¶æŠŠè§£ç åçš„ç»“æœå† download å›æ¥ã€‚

GStreamer ä½¿ç”¨äº†ä¸€ä¸ªåä¸º [GstMemory](https://gstreamer.freedesktop.org/documentation/gstreamer/gstmemory.html?gi-language=c) æ¥ __ç»Ÿä¸€__ åœ°æè¿°ä½äºè®¾å¤‡æˆ–ç³»ç»Ÿå†…å­˜ä¸­çš„ Bufferï¼›è€Œ Buffer çš„å…ƒæ•°æ®ï¼Œè¯¸å¦‚ Width / Height / Stride / Format (NV12, RGB...)ï¼Œä»¥åŠ Timestamp ç­‰ï¼Œç”± [GstMeta](https://gstreamer.freedesktop.org/documentation/gstreamer/gstmeta.html?gi-language=c#GstMetaInfo) æ¥æè¿°ã€‚

æœ€åå†ç”¨ä¸€ä¸ª [GstBuffer](https://gstreamer.freedesktop.org/documentation/gstreamer/gstbuffer.html) æ¥ç»‘å®š GstMemory å’Œ GstMetaï¼Œä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

### æ¯”è¾ƒï¼šæ¨ç†ä¸å¤šåª’ä½“è´Ÿè½½

ç¥ç»ç½‘ç»œæ¨ç†è´Ÿè½½ï¼Œå·²è¶…è¿‡å¤šåª’ä½“æˆäº†ç«¯ä¸Šè®¡ç®—èµ„æºçš„å¤´å·é»‘æ´ã€‚é™„å½•ç»™å‡ºä¸€ä¸ªå¯¹è¯¥è´Ÿè½½åŠ é€Ÿçš„æ¦‚è¿°ï¼ŒåŸºäºå„ç§ç®—æ³•å’Œè½¯ä»¶ä¸Šçš„æ–¹æ³•ã€‚

åŒå¤šåª’ä½“è´Ÿè½½ä¸€æ ·ï¼Œæ¨ç†ä¹Ÿå­˜åœ¨ä¸“ç”¨åŠ é€Ÿç¡¬ä»¶ï¼Œå¦‚ GPU ä»¥åŠæ›´ä¸“ç”¨çš„ ASIC èŠ¯ç‰‡ã€‚

> ä¾‹å¦‚ Telsa çš„ Autopilot è‡ªåŠ¨é©¾é©¶ç³»ç»Ÿï¼ŒHW 3.0 å°±æ˜¯åŸºäºå…¶è‡ªç ”çš„ä¸“ç”¨ ASIC èŠ¯ç‰‡ã€‚æ¯” HW 2.5 åŸºäº GPU çš„æ–¹æ¡ˆï¼Œæ•ˆç‡ä¸Šä¼šé«˜ä¸å°‘ã€‚

åŒå¤šåª’ä½“ç¡¬ä»¶åŠ é€Ÿä¸€æ ·ï¼Œç«¯ä¸Šæ¨ç†æœ‰ç¡¬ä»¶åŠ é€Ÿï¼Œä¾‹å¦‚ GPUï¼ŒDSPï¼Œæˆ–æ˜¯ GPU + DSPã€‚æ­¤æ—¶ï¼Œå¯¹ Buffer è¿›è¡ŒæŠ½è±¡ï¼Œæ˜¯æ¡†æ¶å±‚é¢å®ç° zero-copy ä»¥åŠ less-format-conversion ç­‰ä¼˜åŒ–è·¯å¾„çš„å¿…éœ€ã€‚

> Nvidia ä½œä¸ºæ¨ªè·¨å›¾å½¢å’Œäººå·¥æ™ºèƒ½é¢†åŸŸã€ç‚™æ‰‹å¯çƒ­çš„ GPU ä¾›åº”å•†ï¼Œåœ¨æ¨è¿›ä¸€ä¸ª [Generic Allocator](https://www.phoronix.com/scan.php?page=news_item&px=NVIDIA-Generic-Allocator-2019) æ–¹æ¡ˆã€‚åœ¨ Buffer format åŸºç¡€ä¸Šï¼Œä¸°å¯Œ format modifier æ¥æè¿° tiling æƒ…å†µï¼Œå¹¶æ–¹ä¾¿å„ä¸ªç¡¬ä»¶å¯¹æ ¼å¼çš„åå•†ã€‚


ä»æ§åˆ¶æµè§’åº¦æ¥çœ‹ï¼ŒGPU ä½œä¸ºæ¨ç†è´Ÿè½½çš„å¸¸ç”¨ç¡¬ä»¶ï¼Œå…¶æ§åˆ¶æµç±»ä¼¼ push mode â€”â€” ç®—å­åœ¨ GPU ä¸Šå®ç°ä¸º kernelï¼Œè¾“å‡ºè¾“å…¥ä¸²èµ·çš„ä¸¤ä¸ª kernels ä¼šæ’é˜Ÿåœ¨ command queue ä¸­ï¼Œä¾æ¬¡è¢«æ‰§è¡Œã€‚

Pull mode â€”â€” å› å…¶å­˜åœ¨æ¡ä»¶åˆ¤æ–­åŠé˜»å¡é€»è¾‘ â€”â€” å¯¹æ¨ç†åŠ é€Ÿç¡¬ä»¶è€Œè¨€ï¼Œé€šå¸¸æ˜¯ä¸å‹å¥½çš„ã€‚

> Apple åœ¨ A13 å¤„ç†å™¨çš„ä¸¤ä¸ªå¤§æ ¸ä¸­ï¼ŒåŠ å…¥äº†æœºå™¨å­¦ä¹ åŠ é€Ÿå•å…ƒ AMXï¼Œæ‰©å±•äº†ç›¸åº”çš„ [AMX æŒ‡ä»¤é›†](https://www.anandtech.com/show/14892/the-apple-iphone-11-pro-and-max-review/2)ã€‚è¿™ç§ç›´æ¥å…¥é©» CPU çš„æ–¹å¼ï¼Œåº”è¯¥èƒ½æ”¹å–„åŠ é€Ÿå•å…ƒå¯¹ â€œæ¡ä»¶æœ‰åˆ†æ”¯ä¸å‹å¥½â€ çš„ç°çŠ¶ã€‚


æœ€åçš„ä¸€ä¸ªæ¯”è¾ƒè§’åº¦ï¼Œè€ƒè™‘æ¨ç†å’Œå¤šåª’ä½“æµä¸­ï¼Œè´Ÿè½½æœ€é‡çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚æ¨ç†çš„ Conv ç®—å­å’Œå¤šåª’ä½“çš„ç¼–/è§£ç å™¨ã€‚
- ä»å®ç°ä¸Šçœ‹ï¼Œä¸¤è€…éƒ½å¯åŸºäº GPU å®ç°
> [h264_CUVID](https://devblogs.nvidia.com/nvidia-ffmpeg-transcoding-guide/) æ˜¯ffmpeg åŒ…å«çš„ã€åŸºäº CUDA çš„ h264 è§£ç å™¨ã€‚

- ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œå­˜åœ¨çº¯åŸºäºç¥ç»ç½‘ç»œçš„è§†é¢‘ç¼–/è§£ç å™¨ï¼ˆè‡ªæœ‰ç¼–ç è¿‡ç¨‹ï¼‰ã€‚ä¸è¿‡ä»å±è¯•éªŒæ€§è´¨ï¼Œå‹ç¼©æ¯”ç›¸è¿‘ä½†ç®—åŠ›è¦æ±‚æ›´é«˜

ç¥ç»ç½‘ç»œçš„ç®—å­ä¼˜åŒ–ï¼Œæ­£ä»äººå·¥ç¼–å†™çš„é«˜è´¨é‡ä»£ç ï¼Œé€æ­¥ä¾èµ–æœºå™¨è‡ªåŠ¨è°ƒä¼˜ã€ç”Ÿæˆæ›´é«˜è´¨é‡ä»£ç ã€‚å‰è€…çš„ä»£è¡¨æ˜¯ cuDNNåº“ï¼ˆä»¥åŠä¾èµ–çš„æ•°å­¦åº“ cuBlas åº“ï¼‰ï¼Œå®ƒæ˜¯ Nvidia æä¾›çš„ã€äººå·¥ç¼–å†™çš„ç®—å­å®ç°ã€‚

åè€…çš„ä»£è¡¨ï¼Œä¾‹å¦‚ tvm çš„ [auto tuning æœºåˆ¶](https://docs.tvm.ai/tutorials/index.html#auto-tuning)ã€ä»¥åŠ [polyhedral scheduling](https://pliss2019.github.io/albert_cohen_slides.pdf)ã€‚

è¿™äº›æœºå™¨è‡ªåŠ¨è°ƒä¼˜çš„æ–¹æ³•ï¼ŒåŒæ ·å¯ä»¥åº”ç”¨åœ¨å¤šåª’ä½“ç¼–/è§£ç å™¨çš„ä¼˜åŒ–ä¸­ã€‚



### Unified Graph: æ¨ç†ä¸å¤šåª’ä½“

å‰ä¸€èŠ‚æ¯”è¾ƒæ¨ç†å’Œå¤šåª’ä½“è´Ÿè½½ï¼Œæˆ‘ä»¬å‘ç°ï¼š

- ä¸¤è€…éƒ½æœ‰å¼‚æ„è®¡ç®—æƒ…å½¢ã€‚è¿™æ„å‘³ buffers åœ¨ä¸åŒè®¡ç®—å•å…ƒæµè½¬æ—¶ï¼Œå­˜åœ¨ zero-copy å’Œ less-format-conversion ç­‰ä¼˜åŒ–æœºä¼šã€‚è€Œè¿™æ ·çš„ä¼˜åŒ–ï¼Œå¿…ç„¶è¦å®šä¹‰ _buffer æŠ½è±¡_ ä»¥åŠ _buffer allocator_
- æ§åˆ¶æµä¸Šï¼Œæ¨ç†å¤šæ•°æƒ…å†µç±»æ¯” _pull mode_
- é«˜è´Ÿè½½éƒ¨åˆ†ï¼Œä¸¤è€…éƒ½å¯ä»¥åº”ç”¨ _è‡ªåŠ¨è°ƒä¼˜_ ã€‚ä¾‹å¦‚å¯¹äº CUDA ç¼–ç¨‹ï¼Œå°†å„ä¸ªç»´åº¦å±•å¼€åˆ° blockã€thread ä¸Šã€‚å¹¶è°ƒæ•´ Statements çš„é¡ºåºï¼Œæå‡è®¡ç®—å¹¶è¡Œåº¦å’Œè®¿å­˜å±€åŸŸæ€§

æœ¬èŠ‚åˆ™æŠ›ç –å¼•ç‰ï¼Œè¿›è¡Œä¸€äº›å¼€æ”¾å¼çš„å±•æœ›ã€‚

åœ¨å¤šæ•°å®é™…åº”ç”¨ä¸­ï¼Œå¤šåª’ä½“å’Œæ¨ç†æ˜¯ä½å¤´ä¸è§æŠ¬å¤´è§çš„é‚»å±…ã€‚ä¾‹å¦‚ä»æ‘„åƒå¤´é‡‡é›†ç”»é¢ï¼Œå¤„ç†åé€å…¥æ¨ç†ï¼Œè¿›è¡Œç‰©ä½“è¯†åˆ«ï¼›æˆ–éº¦å…‹é£é‡‡é›†éŸ³é¢‘ï¼Œå¤„ç†åé€å…¥è¯­éŸ³è¯†åˆ«ã€‚

å¦ä¸€æ–¹é¢ï¼Œå‡ ä¹æ‰€æœ‰çš„æ¨ç†å¼•æ“ï¼ˆGoogle TF Liteã€Nvidia TensorRTã€Qualcomm SNPEã€Arm NNã€Intel OpenVINOã€Tencent NCNNã€Alibaba MNNã€ ...ï¼‰åªæè¿°äº†æ¨ç†å›¾ç»“æ„ã€‚

è€ƒè™‘è´Ÿè½½ç›¸ä¼¼æ€§å’Œåº”ç”¨ä¸Šçš„è€¦åˆï¼Œå±•æœ›ç»Ÿä¸€çš„å›¾ï¼ˆUnified Graphï¼‰ï¼Œæè¿°ä¸€ä¸ªå¤šåª’ä½“ + æ¨ç†çš„æ··åˆæµï¼Œä»è€Œå¯¹ App å¼€å‘è€…éšè—ä¼˜åŒ–ç»†èŠ‚ï¼ˆæµçš„ overlapã€buffer è·¨ç•Œæµè½¬ï¼Œç”šè‡³æ˜¯ç®—å­çš„è·¨ç•Œåˆå¹¶ï¼‰ï¼Œæ¦¨å¹²ç¡¬ä»¶æ€§èƒ½çš„åŒæ—¶ï¼Œåˆæ–¹ä¾¿åº”ç”¨å¼€å‘ã€‚

> è¿›ä¸€æ­¥å±•æœ›ï¼ŒæŒ‰ç…§ Multi-Level IR æ¦‚å¿µï¼Œå°† Unified Graph é€æ­¥ Lowering å¹¶å¤ç”¨å„å±‚çš„ä¼˜åŒ– Passï¼Œä½¿å¾—è¿™ä¸ªâ€œå¤šåª’ä½“ + æ¨ç†â€ çš„ç®¡çº¿å¾—åˆ°æè‡´ä¼˜åŒ–ã€‚
>
> ![image](/wp-content/uploads/2020/06/infer-intro/Uni-Graph-mlir.jpg)



## é™„å½•

### Convolution Gallery

| Conv                                             | Diagram                                          |
| ------------------------------------------------ | ------------------------------------------------ |
| Conv 3x3, no-padding, stride=1                   | ![image](/wp-content/uploads/2020/06/infer-intro/no_padding_no_strides.gif)              |
| Conv 3x3, no-padding, stride=2                   | ![image](/wp-content/uploads/2020/06/infer-intro/no_padding_strides.gif)                 |
| Conv 3x3, same-padding, stride=1                 | ![image](/wp-content/uploads/2020/06/infer-intro/same_padding_no_strides.gif)            |
| Transpose Conv 3x3, padding=2, stride=2          | ![image](/wp-content/uploads/2020/06/infer-intro/padding_strides_transposed.gif) |
| Dilated Conv, no-padding, dilation=1, stride = 1 | ![image](/wp-content/uploads/2020/06/infer-intro/dilation.gif)                           |

### ç«¯ä¾§æ¨ç†åŠ é€Ÿæ–¹æ³•é›†

| åˆ†ç±»         | æ–¹æ³•                            | èƒŒåç§è¯­                                                     |
| ------------ | ------------------------------- | ------------------------------------------------------------ |
| ä¼˜åŒ–æ¨ç†ç½‘ç»œ | ä½¿ç”¨ç»å…¸è½»é‡ç½‘ç»œ                | ä¾‹å¦‚ï¼ŒMobilenet ç³»åˆ—ï¼ŒShuffleNet ç³»åˆ—                        |
|              | è‡ªåŠ¨ç”Ÿæˆé«˜æ•ˆç½‘ç»œ                | ä¾‹å¦‚ï¼Œä½œåŠ æ³•çš„ NASï¼ˆ[Neural Architecture Search](https://blog.csdn.net/jinzhuojun/article/details/84698471?spm=ata.13261165.0.0.7492793fTfRBDH)ï¼‰ï¼Œä½œå‡æ³•çš„ [Once for All](https://zhuanlan.zhihu.com/p/80509850) |
|              | ...                             |                                                              |
| ä¼˜åŒ–æ¨ç†å®ç° | ç®—å­çš„é«˜æ•ˆå®ç°ç®—æ³•              | ä¾‹å¦‚ï¼ŒConv æœ‰æ»‘çª—ã€Im2col å’Œ Winograd ä¸‰ç§å®ç°ç®—æ³•           |
|              | ç²¾åº¦æ¢é€Ÿåº¦                      | ä¾‹å¦‚ï¼Œé‡åŒ–è®¡ç®—ï¼Œç”¨ int8 ç”šè‡³ int4ï¼Œæ¥æ›¿ä»£ fp32               |
|              | ç®—å­çš„åˆå¹¶                      | ä¾‹å¦‚ï¼Œ<br/>- å‚ç›´åˆå¹¶ï¼šè¾“å…¥è¾“å‡ºä¸²èµ·çš„ç®—å­åˆæˆä¸€ä¸ªï¼Œæ”¶æ•ˆæ˜æ˜¾ã€‚ç›¸å½“äºæŠŠè®¿å­˜å¯†é›†å‹ï¼Œè½¬å˜ä¸ºè®¡ç®—å¯†é›†å‹<br/>- æ°´å¹³åˆå¹¶ï¼šå¤šè·¯å¹¶è¡Œç®—å­ï¼Œåˆæˆä¸€ä¸ªå¡å…¥ GPU ç­‰è¶…å®½ç¡¬ä»¶ã€‚ç±»æ¯”é€šè¿‡æ‹¼è½¦ï¼Œæé«˜è¿å®¢æ•ˆç‡ |
|              | å•ä¸ªç®—å­çš„è‡ªåŠ¨è°ƒä¼˜ï¼ˆAuto-tuneï¼‰ | è°ƒæ•´ç®—å­å®ç°ä¸­ï¼Œå¤šä¸ªå¾ªç¯ä¸­çš„è¯­å¥ï¼ˆstatementsï¼‰ï¼šå…¶å…ˆåé¡ºåºï¼Œæˆ–è€…åˆ° thread / block çš„æ˜ å°„ï¼Œæœ¯è¯­æ›° scheduleï¼Œåªä¸è¿‡è°ƒåº¦çš„æ˜¯ statements |
|              | ...                             |                                                              |





